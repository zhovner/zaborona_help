@def $VPN = zaborona;
@def $WAN_4 = eth0;
@def $WAN_6 = eth0;
@def $IPSEC_ADDR_4 = 10.14.20.0/22;
@def $VPN_ADDR_4 = 192.168.224.0/22;

@def $ALLOW_SSH = (
Allow SSH access from this IPS
);


@def $ALLOWED_NETWORKS_V4 = (
87.240.128.0/18
93.186.224.0/20
95.142.192.0/20
95.213.0.0/18
185.29.130.0/24
185.32.248.0/22
5.45.192.0/18
5.255.192.0/18
37.9.64.0/18
37.140.128.0/18
77.75.152.0/21
77.88.0.0/18
84.201.128.0/18
87.250.224.0/19
93.158.128.0/18
95.108.128.0/17
100.43.64.0/19
109.235.160.0/21
130.193.32.0/19
141.8.128.0/18
178.154.128.0/17
185.32.185.0/24
185.32.186.0/24
185.71.76.0/22
199.21.96.0/22
199.36.240.0/22
213.180.192.0/19
5.61.16.0/21
5.61.232.0/21
79.137.157.0/24
79.137.183.0/24
94.100.176.0/20
95.163.32.0/19
95.163.248.0/21
128.140.168.0/21
178.22.88.0/21
178.237.16.0/20
185.5.136.0/22
185.16.148.0/22
185.16.244.0/22
188.93.56.0/21
194.186.63.0/24
195.211.20.0/22
195.218.168.0/24
217.20.144.0/20
217.69.128.0/20
185.16.244.0/23
195.211.128.0/22
208.87.92.0/22
77.74.176.0/21
91.103.64.0/21
93.159.224.0/21
185.54.220.0/23
185.85.12.0/24
185.85.14.0/23
77.74.176.0/22
77.74.181.0/24
77.74.183.0/24
93.159.228.0/22
8.8.8.8/32
8.8.4.4/32
74.82.42.42/32
77.75.152.0/21
185.71.76.0/21
178.248.237.68/32
);

@def $ALLOWED_NETWORKS_V6 = (
2a00:bdc0::/36
2a00:bdc0:e003::/48
2a00:bdc0:e004::/46
2a00:bdc0:e008::/48
2a00:bdc0:f000::/36
2001:678:384::/48
2620:10f:d000::/44
2a02:6b8::/32
2a02:5180::/32
2a00:1148::/32
2a00:a300::/32
2a00:b4c0::/32
2a03:2480::/33
2a00:bdc0:e006::/48
2001:4860:4860::8888
);

# IPv4
table filter {
  chain FORWARD {
      policy DROP;
      mod conntrack ctstate INVALID DROP;
      if $WAN_4 of ($VPN $WAN_4) mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT;
      if $VPN of $WAN_4 daddr $ALLOWED_NETWORKS_V4 ACCEPT;
      saddr $IPSEC_ADDR_4 daddr $ALLOWED_NETWORKS_V4 ACCEPT;
  }
  chain INPUT {
      mod conntrack ctstate INVALID DROP;
      saddr $ALLOW_SSH protocol tcp dport 22 ACCEPT;
      protocol tcp dport 22 REJECT reject-with icmp-port-unreachable;
  }
}

table nat {
   chain POSTROUTING {
       saddr $VPN_ADDR_4 of $WAN_4 MASQUERADE;
       saddr $IPSEC_ADDR_4 of $WAN_4 MASQUERADE;
   }
}

# IPv6:
domain ip6 {
   table filter {
       chain FORWARD {
           policy DROP;
           mod conntrack ctstate INVALID DROP;
           if $WAN_6 of $VPN mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT;
           if $VPN of $WAN_6 daddr $ALLOWED_NETWORKS_V6 ACCEPT;
           
       }
   }
}
